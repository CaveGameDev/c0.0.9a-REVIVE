<!DOCTYPE html>
<html>
<head>
    <title>Minecraft (c0.0.9a) - Direct CheerpJ 4.1 Launch</title>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background-color: black; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            font-family: sans-serif;
            color: white;
        }
        #gameCanvas {
            width: 854px; 
            height: 480px;
            display: block; 
            background-color: black; 
        }
        .loading-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        progress {
            width: 80%;
            height: 25px;
            margin-top: 20px;
        }
    </style>
    <script src="https://cjrtnc.leaningtech.com/4.1/loader.js"></script>
</head>
<body>

    <div id="loading-screen" class="loading-overlay">
        <h1>Loading Minecraft...</h1>
        <p id="loading-status">Initializing CheerpJ...</p>
        <progress id="download-progress" value="0" max="100"></progress>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script type="module">
        (async () => {
            const loadingScreen = document.getElementById('loading-screen');
            const loadingStatus = document.getElementById('loading-status');
            const downloadProgress = document.getElementById('download-progress');

            // Define all JAR paths as CheerpJ virtual filesystem paths.
            const minecraftJarPath = "/client/minecraft.jar"; 
            const lwjglJarPath = "/client/lwjgl.jar";         
            const lwjglUtilJarPath = "/client/lwjgl_util-2.9.3.jar"; 
            const jinputJarPath = "/client/jinput.jar";         

            const mainClass = "com.mojang.minecraft.Minecraft";
            
            const runtimeClasspath = [
                minecraftJarPath,
                lwjglJarPath,
                lwjglUtilJarPath,
                jinputJarPath
            ].join(':');

            const launcherArgs = [];

            // --- 1. Initialize CheerpJ ---
            loadingStatus.textContent = "Initializing CheerpJ...";
            await cheerpjInit({
                version: 8,
                javaProperties: [
                    "java.library.path=/client/libraries/",
                    "java.awt.headless=false",
                    "cheerpj.dom.async=true",
                    "cheerpj.x11.display=true",
                    "sun.java2d.nodraw=true",
                    "sun.awt.noerasebackground=true",
                    "sun.java2d.d3d=false",
                    "sun.java2d.opengl=false",
                    "org.lwjgl.Sys.debug=true",
                ],
                libraries: {
                    "libGL.so.1": "/client/libraries/gl4es.wasm"
                },
                enableX11:true,
                console: "log",
                enableDownloadCallback: true, // This enables the callback, but doesn't define it yet
                mountFS: {
                    "/client/": "./client/" 
                }
            });

            console.log("CheerpJ initialized.");
            loadingStatus.textContent = "CheerpJ initialized. Creating display...";

            // --- 2. Create the CheerpJ display ---
            cheerpjCreateDisplay(854, 480);

            // --- 3. Link LWJGL to the HTML canvas element ---
            window.lwjglCanvasElement = document.getElementById("gameCanvas");

            console.log("CheerpJ display created and canvas linked.");
            loadingStatus.textContent = "Launching Minecraft...";

            // --- Handle CheerpJ Download Progress (MOVED HERE) ---
            // NOW that cheerpjInit() has completed, 'cheerpj' is defined and safe to use.
            cheerpj.enableDownloadCallback(function(url, loaded, total) {
                if (total > 0) {
                    const progress = Math.round((loaded / total) * 100);
                    downloadProgress.value = loaded;
                    downloadProgress.max = total;
                    loadingStatus.textContent = `Downloading: ${url.split('/').pop()} - ${progress}%`;
                } else {
                    loadingStatus.textContent = `Downloading: ${url.split('/').pop()}`;
                }
            });

            // --- 4. Run the Minecraft application ---
            await cheerpjRunMain(
                mainClass,
                runtimeClasspath,
                launcherArgs
            );

            console.log("Minecraft application started.");
            loadingScreen.style.display = 'none'; 
        })();
    </script>
</body>
</html>
